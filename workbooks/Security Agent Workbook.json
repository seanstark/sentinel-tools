{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "loadType": "always",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Connected Machines & Security Agents\n"
            },
            "name": "Title"
          },
          {
            "type": 1,
            "content": {
              "json": "This workbook show extensions (agents) installed on Native Azure and Azure Arc Connected Machines only. This workbook will not show machines not connected with Azure Arc.",
              "style": "warning"
            },
            "name": "text - 7"
          },
          {
            "type": 1,
            "content": {
              "json": "#### Workbook Global Filters"
            },
            "name": "text - 2"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "parameters": [
                {
                  "id": "130a5425-6a32-4eb5-bbf9-20e3813df8b4",
                  "version": "KqlParameterItem/1.0",
                  "name": "Subscription",
                  "type": 6,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::all"
                    ],
                    "includeAll": true,
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::all",
                  "value": [
                    "/subscriptions/d1d8779d-38d7-4f06-91db-9cbc8de0176f",
                    "/subscriptions/45f9252d-e27e-4ed8-ab4e-dc5054de13fa",
                    "/subscriptions/ebb79bc0-aa86-44a7-8111-cabbe0c43993"
                  ]
                },
                {
                  "id": "290051bb-a82a-4234-8b86-af5df0b87f86",
                  "version": "KqlParameterItem/1.0",
                  "name": "Workspace",
                  "type": 5,
                  "isRequired": true,
                  "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| project value =id, label = name",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::1"
                    ],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "defaultValue": "value::1",
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                },
                {
                  "id": "f8321a8b-90ac-43ae-a0fd-8f157e971808",
                  "version": "KqlParameterItem/1.0",
                  "name": "showHiddenObjects",
                  "type": 10,
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "jsonData": "[\r\n    { \"value\": \"True\", \"label\":\"Yes\"}, \r\n    { \"value\": \"False\", \"label\":\"No\", \"selected\":true }\r\n]"
                },
                {
                  "id": "04829011-99d5-490e-8bf3-516a27d22b42",
                  "version": "KqlParameterItem/1.0",
                  "name": "machineTag",
                  "label": "Machine Tags",
                  "type": 2,
                  "query": "Resources\r\n| where type =~ 'Microsoft.Compute/virtualMachines' or \r\ntype == \"microsoft.compute/virtualmachinescalesets\" or\r\ntype == \"microsoft.hybridcompute/machines\"\r\n| where isnotempty(tags)\r\n| project tags\r\n| mvexpand tags\r\n| extend tagKey = tostring(bag_keys(tags)[0])\r\n| distinct tagKey",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": null
                },
                {
                  "id": "f1a97731-1029-4dbb-b1b7-cb2bc73e09ef",
                  "version": "KqlParameterItem/1.0",
                  "name": "machineTagValue",
                  "label": "Tag Value",
                  "type": 2,
                  "isRequired": true,
                  "query": "Resources\r\n| where type =~ 'Microsoft.Compute/virtualMachines' or \r\ntype == \"microsoft.compute/virtualmachinescalesets\" or\r\ntype == \"microsoft.hybridcompute/machines\"\r\n| where isnotempty(tags)\r\n| project tags\r\n| mvexpand tags\r\n| extend tagKey = tostring(bag_keys(tags)[0])\r\n| where tagKey == \"{machineTag}\"\r\n| extend tagValue = tostring(tags[tagKey])\r\n| distinct tagValue\r\n",
                  "crossComponentResources": [
                    "{Subscription}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [
                      "value::1"
                    ],
                    "showDefault": false
                  },
                  "defaultValue": "value::1",
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources"
                },
                {
                  "id": "dd26bd17-eeaf-4aa9-a515-ed1ce9be0d71",
                  "version": "KqlParameterItem/1.0",
                  "name": "securityAgents",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "\"Legacy Log Analytics\", \"Defender for Servers P2\", \"Azure Monitor Agent\", \"Defender for Endpoint\", \"Azure Guest Configuration\", \"Qualys\", \"Azure Arc\""
                      }
                    }
                  ]
                }
              ],
              "style": "above",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "name": "Global Filters"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "tabStyle": "bigger",
              "links": [
                {
                  "id": "00081a76-3f0b-4aae-b959-69ea40df8c10",
                  "cellValue": "Tab",
                  "linkTarget": "parameter",
                  "linkLabel": "Overview",
                  "subTarget": "overview",
                  "style": "link"
                },
                {
                  "id": "2f7f8aec-9b5c-4c67-b445-8bab8f03d014",
                  "cellValue": "Tab",
                  "linkTarget": "parameter",
                  "linkLabel": "Connected Machines",
                  "subTarget": "connectedMachines",
                  "style": "link"
                },
                {
                  "id": "c2313403-0c71-47d7-a2a3-94fbc2b5a20e",
                  "cellValue": "Tab",
                  "linkTarget": "parameter",
                  "linkLabel": "Data Collection Rules",
                  "subTarget": "dataCollectionRules",
                  "style": "link"
                }
              ]
            },
            "name": "tab"
          }
        ],
        "exportParameters": true
      },
      "name": "topSection"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "crossComponentResources": [
          "{Subscription}"
        ],
        "parameters": [
          {
            "id": "8e238a36-fc4c-4a98-976f-a53294c1db87",
            "version": "KqlParameterItem/1.0",
            "name": "topVmLocation",
            "type": 1,
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'Microsoft.Compute/virtualMachines'\r\n| project location\r\n| top 1 by location",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "9116ed8d-2865-469e-8f2d-e18814e804a4",
            "version": "KqlParameterItem/1.0",
            "name": "topVmSubscription",
            "type": 1,
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'Microsoft.Compute/virtualMachines'\r\n| project location, subscriptionId\r\n| top 1 by location\r\n| project subscriptionId",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "c350e495-da30-43f9-9448-e40d74112ea3",
            "version": "KqlParameterItem/1.0",
            "name": "selectVersionRegion",
            "label": "Version Region",
            "type": 8,
            "description": "Select the Region to pull latest agent versions from",
            "typeSettings": {
              "additionalResourceOptions": [],
              "includeAll": true
            },
            "value": null
          },
          {
            "id": "403c3270-df33-4c68-b47d-f2c5b4804901",
            "version": "KqlParameterItem/1.0",
            "name": "selectedRegion",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "selectVersionRegion",
                  "operator": "is Empty",
                  "rightValType": "param",
                  "resultValType": "param",
                  "resultVal": "topVmLocation"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "param",
                  "resultVal": "selectVersionRegion"
                }
              }
            ]
          },
          {
            "id": "5ce7b1ca-d6b7-43fa-b280-5caf5763adf6",
            "version": "KqlParameterItem/1.0",
            "name": "mdeLinuxLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.Azure.AzureDefenderForServers/artifacttypes/vmextension/types/MDE.Linux/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "31ae95f4-8420-464b-8e7b-aeb94ed18dc8",
            "version": "KqlParameterItem/1.0",
            "name": "mdeWindowsLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.Azure.AzureDefenderForServers/artifacttypes/vmextension/types/MDE.Linux/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "dfdd6b4b-b053-4a67-bf8e-2834d57c663e",
            "version": "KqlParameterItem/1.0",
            "name": "amaLinuxLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.Azure.Monitor/artifacttypes/vmextension/types/AzureMonitorLinuxAgent/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "d0b248b2-4745-4ac4-ba92-960d45962870",
            "version": "KqlParameterItem/1.0",
            "name": "amaWindowsLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.Azure.Monitor/artifacttypes/vmextension/types/AzureMonitorWindowsAgent/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "381179b3-b386-4800-bd37-fd21abdb919d",
            "version": "KqlParameterItem/1.0",
            "name": "defenderLinuxLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.Azure.Security.Monitoring/artifacttypes/vmextension/types/AzureSecurityLinuxAgent/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "cac9db84-fd9d-45e5-b9ec-12fedb716ce5",
            "version": "KqlParameterItem/1.0",
            "name": "defenderWindowsLatestVersions",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.Azure.Security.Monitoring/artifacttypes/vmextension/types/AzureSecurityWindowsAgent/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "e377785d-bf9a-4bd5-a82a-ac5fe33ff9e4",
            "version": "KqlParameterItem/1.0",
            "name": "guestConfigLinuxLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.GuestConfiguration/artifacttypes/vmextension/types/ConfigurationforLinux/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "9c50b860-9fbe-47a0-8a7e-0d2bdd6bfcb7",
            "version": "KqlParameterItem/1.0",
            "name": "guestConfigWindowsLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.GuestConfiguration/artifacttypes/vmextension/types/ConfigurationforWindows/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "28ec80e2-7364-4f88-b8e7-e65eedbdfb4b",
            "version": "KqlParameterItem/1.0",
            "name": "mmaWindowsLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.EnterpriseCloud.Monitoring/artifacttypes/vmextension/types/MicrosoftMonitoringAgent/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "dba8f4d1-ef62-45cf-a752-819a6f1da18a",
            "version": "KqlParameterItem/1.0",
            "name": "mmaLinuxLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Microsoft.EnterpriseCloud.Monitoring/artifacttypes/vmextension/types/OmsAgentForLinux/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "536ffc31-876c-4235-8ae5-ec9d5f37b3b0",
            "version": "KqlParameterItem/1.0",
            "name": "qualysLinuxLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Qualys/artifacttypes/vmextension/types/LinuxAgent.AzureSecurityCenter/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "id": "94028af5-1733-4db3-9e56-932c73d45ea1",
            "version": "KqlParameterItem/1.0",
            "name": "qualysWindowsLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{topVmSubscription}/providers/Microsoft.Compute/locations/{selectedRegion}/publishers/Qualys/artifacttypes/vmextension/types/WindowsAgent.AzureSecurityCenter/versions?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2022-08-01\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$[*].name\",\"columns\":[]}}]}",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 12
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "arcWindowsLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "jsonData": "[\"N/A\"]",
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "id": "e8a02372-a51a-48f0-8322-8127577a549b",
            "value": [
              "value::all"
            ]
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "arcLinuxLatestVersion",
            "type": 2,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "jsonData": "[\"N/A\"]",
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "id": "a3c7c0e1-19d9-400b-a354-e08bd82a6779",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "above",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "conditionalVisibility": {
        "parameterName": "showHiddenObjects",
        "comparison": "isEqualTo",
        "value": "True"
      },
      "name": "versionParameters"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let versionTable = datatable(agent:string, version:string)\r\n[\r\n    \"mdeLinuxLatestVersion\", \"{mdeLinuxLatestVersion}\",\r\n    \"mdeWindowsLatestVersion\", \"{mdeWindowsLatestVersion}\",\r\n    \"amaLinuxLatestVersion\", \"{amaLinuxLatestVersion}\",\r\n    \"amaWindowsLatestVersion\", \"{amaWindowsLatestVersion}\",\r\n    \"defenderLinuxLatestVersion\", \"{defenderLinuxLatestVersion}\",\r\n    \"defenderWindowsLatestVersions\", \"{defenderWindowsLatestVersions}\",\r\n    \"guestConfigLinuxLatestVersion\", \"{guestConfigLinuxLatestVersion}\",\r\n    \"guestConfigWindowsLatestVersion\", \"{guestConfigWindowsLatestVersion}\",\r\n    \"mmaWindowsLatestVersion\", \"{mmaWindowsLatestVersion}\",\r\n    \"mmaLinuxLatestVersion\", \"{mmaLinuxLatestVersion}\",\r\n    \"qualysLinuxLatestVersion\", \"{qualysLinuxLatestVersion}\",\r\n    \"qualysWindowsLatestVersion\", \"{qualysWindowsLatestVersion}\",\r\n    \"arcWindowsLatestVersion\", \"{arcWindowsLatestVersion}\",\r\n    \"arcLinuxLatestVersion\", \"{arcLinuxLatestVersion}\"\r\n];\r\nversionTable\r\n| extend version = replace_regex(version, @\"(')\", @'')\r\n| extend version = todynamic(version)\r\n| mv-expand split(version, ',')\r\n| extend versionco = parse_version(tostring(version))\r\n| summarize arg_max(versionco, *) by agent\r\n| project agent, version",
        "size": 4,
        "title": "Latest Agent Versions Table",
        "timeContext": {
          "durationMs": 1800000
        },
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{Workspace}"
        ],
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "agent",
              "sortOrder": 1
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "agent",
            "sortOrder": 1
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "showHiddenObjects",
        "comparison": "isEqualTo",
        "value": "True"
      },
      "name": "latestAgentVersions"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "2796c6fd-dfcd-4893-b183-b919d791c76f",
                  "version": "KqlParameterItem/1.0",
                  "name": "showLatestVersions",
                  "label": "Show Latest Agent Versions",
                  "type": 10,
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": []
                  },
                  "jsonData": "[\r\n    {\"value\": \"Show\", \"selected\":true},\r\n    {\"value\": \"Hide\"}\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "value": "Hide"
                }
              ],
              "style": "formVertical",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "connectedMachineParams"
          },
          {
            "type": 1,
            "content": {
              "json": "##### This is a consolidated view of all agents. Some columns and values are only applicable to specific agent types. \r\n\r\n- Latest Agent Versions are region specific. This view pulls the latest versions from virtual machines by the top region in your enivornment ({topVmLocation}). You can list all versions for a region via [az vm extension image list-versions](https://learn.microsoft.com/cli/azure/vm/extension/image?view=azure-cli-latest#az-vm-extension-image-list-versions)\r\n\r\n- Verison numbers don't always correlate to installed versions reported by the operating system or docs pages. These version numbers represent the extension version number.\r\n\r\n- Virtual Machine Scale sets do not show the invidual instances running (API Limitation)\r\n\r\n- Azure Arc Latest Version is currently not supported\r\n\r\nThe Log Analytics agents (OMS/MMA) will reach [end of support by August 2024](https://azure.microsoft.com/updates/were-retiring-the-log-analytics-agent-in-azure-monitor-on-31-august-2024/). The Azure Monitor agent is the recommended replacement. Learn more about migrating to [Azure Monitor](https://aka.ms/migratetoAMA)",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "showLatestVersions",
              "comparison": "isEqualTo",
              "value": "Show"
            },
            "name": "text - 2"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n        | where type =~ 'Microsoft.Compute/virtualMachines' or \r\n                type == \"microsoft.compute/virtualmachinescalesets\" or\r\n                type == \"microsoft.hybridcompute/machines\"\r\n        | extend machineId = tolower(id)\r\n        | extend machineStatus = tostring(iff(\r\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.extended.instanceView.powerState.displayStatus,\r\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", 'n/a',\r\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.status,\r\n                                'uknown'))))\r\n        | extend osType = tolower(tostring(iff(\r\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.storageProfile.osDisk.osType,\r\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", properties.virtualMachineProfile.storageProfile.osDisk.osType,\r\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.osType,\r\n                                'uknown')))))\r\n        | extend hostName = tostring(iff(\r\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.extended.instanceView.computerName,\r\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", properties.virtualMachineProfile.osProfile.computerNamePrefix,\r\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.machineFqdn,\r\n                                'uknown'))))\r\n        | project-away id, kind, managedBy, apiVersion, sku, plan, identity, zones, extendedLocation, systemData\r\n        | extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n        | where tostring(tags) contains tagFilter",
              "size": 4,
              "title": "All Machines",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "showHiddenObjects",
              "comparison": "isEqualTo",
              "value": "True"
            },
            "name": "allMachines"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Legacy Log Analytics\\\",\\r\\n\\t\\t\\\"name\\\": \\\"OmsAgentForLinux\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Linux\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"mmaLinuxLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/azure/virtual-machines/extensions/oms-linux\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Legacy Log Analytics\\\",\\r\\n\\t\\t\\\"name\\\": \\\"MicrosoftMonitoringAgent\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Windows\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"mmaWindowsLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/en-us/azure/virtual-machines/extensions/oms-windows\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Defender for Servers P2\\\",\\r\\n\\t\\t\\\"name\\\": \\\"AzureSecurityLinuxAgent\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Linux\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"defenderLinuxLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"N/A\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Defender for Servers P2\\\",\\r\\n\\t\\t\\\"name\\\": \\\"AzureSecurityWindowsAgent\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Windows\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"defenderWindowsLatestVersions\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"N/A\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Azure Monitor Agent\\\",\\r\\n\\t\\t\\\"name\\\": \\\"AzureMonitorLinuxAgent\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Linux\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"amaLinuxLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/azure/azure-monitor/agents/azure-monitor-agent-extension-versions\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Azure Monitor Agent\\\",\\r\\n\\t\\t\\\"name\\\": \\\"AzureMonitorWindowsAgent\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Windows\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"amaWindowsLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/azure/azure-monitor/agents/azure-monitor-agent-extension-versions\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Defender for Endpoint\\\",\\r\\n\\t\\t\\\"name\\\": \\\"MDE.Linux\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Linux\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"mdeLinuxLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/microsoft-365/security/defender-endpoint/linux-whatsnew\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Defender for Endpoint\\\",\\r\\n\\t\\t\\\"name\\\": \\\"MDE.Windows\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Windows\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"mdeWindowsLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/microsoft-365/security/defender-endpoint/windows-whatsnew\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Azure Guest Configuration\\\",\\r\\n\\t\\t\\\"name\\\": \\\"AzurePolicyforLinux\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Linux\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"guestConfigLinuxLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/azure/governance/machine-configuration/agent-notes#release-notes\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Azure Guest Configuration\\\",\\r\\n\\t\\t\\\"name\\\": \\\"AzurePolicyforWindows\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Windows\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"guestConfigWindowsLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/azure/governance/machine-configuration/agent-notes#release-notes\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Qualys\\\",\\r\\n\\t\\t\\\"name\\\": \\\"LinuxAgent.AzureSecurityCenter\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Linux\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"qualysLinuxLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"N/A\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Qualys\\\",\\r\\n\\t\\t\\\"name\\\": \\\"WindowsAgent.AzureSecurityCenter\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Windows\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"qualysWindowsLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"N/A\\\"\\r\\n\\t},\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Azure Arc\\\",\\r\\n\\t\\t\\\"name\\\": \\\"ArcAgentForWindows\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Windows\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"arcWindowsLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/azure/azure-arc/servers/agent-release-notes\\\"\\r\\n\\t}\\r\\n\\t,\\r\\n\\t{\\r\\n\\t\\t\\\"agent\\\": \\\"Azure Arc\\\",\\r\\n\\t\\t\\\"name\\\": \\\"ArcAgentForLinux\\\",\\r\\n\\t\\t\\\"os\\\": \\\"Linux\\\",\\r\\n\\t\\t\\\"latestVersion\\\": \\\"arcLinuxLatestVersion\\\",\\r\\n\\t\\t\\\"versionDocs\\\": \\\"https://learn.microsoft.com/azure/azure-arc/servers/agent-release-notes\\\"\\r\\n\\t}\\r\\n]\",\"transformers\":null}",
              "size": 0,
              "title": "Latest Agents ({topVmLocation})",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 8,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "versionDocs",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "Url"
                    }
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "agent",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "agent",
                    "label": "Agent"
                  },
                  {
                    "columnId": "name",
                    "label": "Extension Name"
                  },
                  {
                    "columnId": "os",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "latestVersion",
                    "label": "Latest Version"
                  },
                  {
                    "columnId": "versionDocs",
                    "label": "Release Notes"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "agent",
                  "sortOrder": 1
                }
              ]
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "showHiddenObjects",
              "comparison": "isEqualTo",
              "value": "True"
            },
            "showPin": false,
            "name": "agentMappings"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"8649e01f-e083-492b-bcbf-f13cccadd72a\",\"mergeType\":\"innerunique\",\"leftTable\":\"agentMappings\",\"rightTable\":\"latestAgentVersions\",\"leftColumn\":\"latestVersion\",\"rightColumn\":\"agent\"}],\"projectRename\":[{\"originalName\":\"[agentMappings].agent\",\"mergedName\":\"Agent\",\"fromId\":\"8649e01f-e083-492b-bcbf-f13cccadd72a\"},{\"originalName\":\"[agentMappings].name\",\"mergedName\":\"name\",\"fromId\":\"8649e01f-e083-492b-bcbf-f13cccadd72a\"},{\"originalName\":\"[agentMappings].os\",\"mergedName\":\"Operating System\",\"fromId\":\"8649e01f-e083-492b-bcbf-f13cccadd72a\"},{\"originalName\":\"[latestAgentVersions].version\",\"mergedName\":\"Latest Version\",\"fromId\":\"8649e01f-e083-492b-bcbf-f13cccadd72a\"},{\"originalName\":\"[agentMappings].versionDocs\",\"mergedName\":\"Release Notes\",\"fromId\":\"8649e01f-e083-492b-bcbf-f13cccadd72a\"},{\"originalName\":\"[latestAgentVersions].versionco\"},{\"originalName\":\"[latestAgentVersions].agent\"},{\"originalName\":\"[agentMappings].latestVersion\"}]}",
              "size": 1,
              "title": "Latest Versions",
              "showRefreshButton": true,
              "queryType": 7,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Release Notes",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "Url"
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "Latest Version",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "name",
                    "label": "Extension Name"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "Latest Version",
                  "sortOrder": 2
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "showLatestVersions",
              "comparison": "isEqualTo",
              "value": "Show"
            },
            "showPin": false,
            "name": "versionsTable"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "tabStyle": "bigger",
              "links": [
                {
                  "id": "405f4fe4-a306-4506-ae80-7f37b8e58921",
                  "cellValue": "agentView",
                  "linkTarget": "parameter",
                  "linkLabel": "All Agents",
                  "subTarget": "All Agents",
                  "style": "link"
                },
                {
                  "id": "bbff16c4-1980-4ef7-b3fc-bf45ecd33a1e",
                  "cellValue": "agentView",
                  "linkTarget": "parameter",
                  "linkLabel": "Azure Monitor Agent",
                  "subTarget": "Azure Monitor Agent",
                  "style": "link"
                },
                {
                  "id": "4acf1595-26d4-484a-a1d2-77c1e992569a",
                  "cellValue": "agentView",
                  "linkTarget": "parameter",
                  "linkLabel": "Defender for Endpoint",
                  "subTarget": "Defender for Endpoint",
                  "style": "link"
                },
                {
                  "id": "22350455-3d92-48b2-b1ae-51f58ad027fa",
                  "cellValue": "agentView",
                  "linkTarget": "parameter",
                  "linkLabel": "Defender for Servers",
                  "subTarget": "Defender for Servers P2",
                  "style": "link"
                },
                {
                  "id": "0bda4994-4c05-4b19-9644-aa7cda3bfa4d",
                  "cellValue": "agentView",
                  "linkTarget": "parameter",
                  "linkLabel": "Guest Configuration",
                  "subTarget": "Azure Guest Configuration",
                  "style": "link"
                },
                {
                  "id": "1fdc311a-214e-4924-98c6-021d8c4b419b",
                  "cellValue": "agentView",
                  "linkTarget": "parameter",
                  "linkLabel": "Legacy Log Analytics",
                  "subTarget": "Legacy Log Analytics",
                  "style": "link"
                },
                {
                  "id": "10e46471-f293-483f-9d44-f628e85b288f",
                  "cellValue": "agentView",
                  "linkTarget": "parameter",
                  "linkLabel": "Azure Arc",
                  "subTarget": "Azure Arc",
                  "style": "link"
                }
              ]
            },
            "name": "agentTabs"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "d4c7b811-64bf-4ba9-93a1-24f12d473a5a",
                  "version": "KqlParameterItem/1.0",
                  "name": "showAgentBreakdown",
                  "label": "Show Agent Breakdown",
                  "type": 10,
                  "isRequired": true,
                  "typeSettings": {
                    "additionalResourceOptions": []
                  },
                  "jsonData": "[\r\n    {\"value\": \"Show\", \"selected\":true},\r\n    {\"value\": \"Hide\"}\r\n]",
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "formVertical",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "showAgentBreakdown"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\" or \r\ntype contains \"microsoft.hybridcompute/machines/extensions\" or\r\ntype contains \"microsoft.compute/virtualmachinescalesets/extensions\"\r\n| extend agent = iff(name =~ 'OmsAgentForLinux', 'Legacy Log Analytics', \r\n                        iff(name =~ \"MicrosoftMonitoringAgent\", 'Legacy Log Analytics',\r\n                        iff(name =~ \"AzureSecurityLinuxAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureSecurityWindowsAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureMonitorWindowsAgent\", 'Azure Monitor Agent',\r\n                        iff(name =~ \"AzureMonitorLinuxAgent\", 'Azure Monitor Agent',\r\n                        iff(name has \"MDE.\", 'Defender for Endpoint',\r\n                        iff(name startswith \"AzurePolicyfor\", 'Azure Guest Configuration',\r\n                        iff(name =~ \"LinuxAgent.AzureSecurityCenter\", 'Qualys',\r\n                        iff(name =~ \"WindowsAgent.AzureSecurityCenter\", 'Qualys',\r\n                    name))))))))))\r\n| where agent in ({securityAgents})\r\n| extend version = tostring(properties.typeHandlerVersion)\r\n| extend view = \"{agentView}\"\r\n| extend viewMatch = case(view == 'All Agents', \" \", view)\r\n| where agent contains viewMatch\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| summarize agentCount = count(),\r\nautoUpgradeEnabled = countif(properties.enableAutomaticUpgrade == true), \r\nautoUpgradeDisabled = countif(properties.enableAutomaticUpgrade == false or isnotempty(properties.enableAutomaticUpgrade)),\r\ninstallSucceeded = countif(properties.provisioningState == 'Succeeded'),\r\ninstallFailed = countif(properties.provisioningState == 'Failed')\r\nby agent, version\r\n| order by agent, agentCount\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Agent Breakdown",
              "showRefreshButton": true,
              "exportedParameters": [
                {
                  "fieldName": "agent",
                  "parameterName": "agentvername",
                  "parameterType": 1,
                  "defaultValue": "\"\""
                },
                {
                  "fieldName": "version",
                  "parameterName": "agentver",
                  "parameterType": 1,
                  "defaultValue": "\"\""
                }
              ],
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "version",
                    "formatter": 0,
                    "formatOptions": {
                      "aggregation": "Sum"
                    }
                  },
                  {
                    "columnMatch": "agent",
                    "formatter": 1,
                    "formatOptions": {
                      "aggregation": "Unique",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "agentCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "12ch"
                    },
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal",
                        "useGrouping": false
                      }
                    }
                  },
                  {
                    "columnMatch": "autoUpgradeEnabled",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "autoUpgradeDisabled",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "orange",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "installSucceeded",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "green",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "installFailed",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "redBright",
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "uniqueVersions",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "purple",
                      "customColumnWidthSetting": "30ch"
                    }
                  }
                ],
                "filter": true,
                "sortBy": [
                  {
                    "itemKey": "agent",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "agent",
                    "label": "Agent"
                  },
                  {
                    "columnId": "version",
                    "label": "Version",
                    "comment": "`"
                  },
                  {
                    "columnId": "agentCount",
                    "label": "Count"
                  },
                  {
                    "columnId": "autoUpgradeEnabled",
                    "label": "Auto Upgrade Enabled"
                  },
                  {
                    "columnId": "autoUpgradeDisabled",
                    "label": "Auto Upgrade Disabled"
                  },
                  {
                    "columnId": "installSucceeded",
                    "label": "Installation Succeeded"
                  },
                  {
                    "columnId": "installFailed",
                    "label": "Installation Failed"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "agent",
                  "sortOrder": 1
                }
              ],
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "acount",
                  "formatter": 1
                },
                "subtitleContent": {
                  "columnMatch": "agent",
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "leftContent": {
                  "columnMatch": "agent",
                  "formatter": 10,
                  "formatOptions": {
                    "palette": "blue",
                    "compositeBarSettings": {
                      "labelText": "",
                      "columnSettings": [
                        {
                          "columnName": "acount",
                          "color": "blue"
                        },
                        {
                          "columnName": "autoUpgrade",
                          "color": "blue"
                        }
                      ]
                    }
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false,
                "size": "auto"
              }
            },
            "conditionalVisibility": {
              "parameterName": "showAgentBreakdown",
              "comparison": "isEqualTo",
              "value": "Show"
            },
            "name": "agentVersionDetails"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "nav",
              "links": [
                {
                  "id": "4827893d-a50b-4dd0-9acf-dfccff1730ee",
                  "cellValue": "missingMachines",
                  "linkTarget": "step",
                  "linkLabel": "View Machines Missing {agentView}",
                  "preText": "",
                  "style": "primary"
                }
              ]
            },
            "name": "missingAgentLink"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\" or \r\n        type contains \"microsoft.hybridcompute/machines/extensions\" or\r\n        type contains \"microsoft.compute/virtualmachinescalesets/extensions\"\r\n| project-away kind, managedBy, sku, plan, identity, zones, extendedLocation, systemData, apiVersion\r\n| extend agent = tostring(iff(name =~ 'OmsAgentForLinux', 'Legacy Log Analytics', \r\n                        iff(name =~ \"MicrosoftMonitoringAgent\", 'Legacy Log Analytics',\r\n                        iff(name =~ \"AzureSecurityLinuxAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureSecurityWindowsAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureMonitorWindowsAgent\", 'Azure Monitor Agent',\r\n                        iff(name =~ \"AzureMonitorLinuxAgent\", 'Azure Monitor Agent',\r\n                        iff(name has \"MDE.\", 'Defender for Endpoint',\r\n                        iff(name startswith \"AzurePolicyfor\", 'Azure Guest Configuration',\r\n                        iff(name =~ \"LinuxAgent.AzureSecurityCenter\", 'Qualys',\r\n                        iff(name =~ \"WindowsAgent.AzureSecurityCenter\", 'Qualys',\r\n                    name)))))))))))\r\n| extend autoUpgradeEnabled = properties.enableAutomaticUpgrade\r\n| extend provisioningState = tostring(properties.provisioningState)\r\n| extend version = tostring(properties.typeHandlerVersion)\r\n| extend vNextEnabled = tostring(properties.settings.vNextEnabled)\r\n| extend statusLevel = tostring(properties.instanceView.status.level)\r\n| extend statusMessage = tostring(properties.instanceView.status.message)\r\n| extend statusCode = tostring(properties.instanceView.status.code)\r\n| extend workspaceId = tostring(properties.settings.workspaceId)\r\n| join kind=leftouter ( // Join Log Analytics Workspaces\r\n        Resources\r\n            | where type == \"microsoft.operationalinsights/workspaces\"\r\n            | extend workspaceId = properties.customerId\r\n            | project workspaceResourceId = id, tostring(workspaceId)\r\n        ) on workspaceId\r\n| parse id with * \"/\" machineId \"/extensions/\" *\r\n| extend machineId =  strcat('/', tolower(machineId))\r\n| join kind=leftouter ( // Join Machines\r\n        Resources\r\n        | where type =~ 'Microsoft.Compute/virtualMachines' or \r\n                type == \"microsoft.compute/virtualmachinescalesets\" or\r\n                type == \"microsoft.hybridcompute/machines\"\r\n        | extend machineId = tolower(id)\r\n        | extend machineStatus = tostring(iff(\r\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.extended.instanceView.powerState.displayStatus,\r\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", 'n/a',\r\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.status,\r\n                                'uknown'))))\r\n        | extend osType = tolower(tostring(iff(\r\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.storageProfile.osDisk.osType,\r\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", properties.virtualMachineProfile.storageProfile.osDisk.osType,\r\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.osType,\r\n                                'uknown')))))\r\n        | extend hostName = tostring(iff(\r\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.extended.instanceView.computerName,\r\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", properties.virtualMachineProfile.osProfile.computerNamePrefix,\r\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.machineFqdn,\r\n                                'uknown'))))\r\n        | project-away kind, managedBy, apiVersion, sku, plan, identity, zones, extendedLocation, systemData\r\n        ) on machineId\r\n| union ( // Union Arc Machines as an Agent\r\n        resources\r\n        | where type == \"microsoft.hybridcompute/machines\"\r\n        | extend agent = \"Azure Arc\"\r\n        | extend name = iff(properties.osType == \"linux\", \"ArcAgentForLinux\", \"ArcAgentForWindows\")\r\n        | extend autoUpgradeEnabled = properties.agentUpgrade[0]\r\n        | extend provisioningState = tostring(properties.provisioningState)\r\n        | extend version = tostring(properties.agentVersion)\r\n        | extend machineId = tolower(tostring(id))\r\n        | extend osType = tostring(properties.osType)\r\n        | extend statusMessage = tostring(properties.errorDetails)\r\n        | extend statusCode = tostring(properties.status)\r\n        | extend hostName = tostring(properties.machineFqdn)\r\n        | extend tags = properties.tags\r\n        | extend machineStatus = tostring(properties.status)\r\n        | project-away apiVersion, systemData, sku, plan, identity, kind, managedBy, zones, extendedLocation\r\n    )\r\n| where agent in ({securityAgents})\r\n| extend view = \"{agentView}\"\r\n| extend viewMatch = case(view == 'All Agents', \" \", view)\r\n| where agent contains viewMatch\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| where agent contains \"{agentvername}\" and version contains \"{agentver}\"\r\n| project-away workspaceId, workspaceId1, id1, name1, type1, tenantId1, location1, resourceGroup1, subscriptionId1, properties1, tags1, machineId1, properties\r\n| project viewMatch, machineId, hostName, osType, machineStatus, agent, provisioningState, version, autoUpgradeEnabled, vNextEnabled, statusLevel, statusCode, statusMessage, workspaceResourceId, subscriptionId, resourceGroup, location, tenantId, type, name, id, tags",
              "size": 0,
              "showAnalytics": true,
              "title": "All Agents",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "conditionalVisibility": {
              "parameterName": "showHiddenObjects",
              "comparison": "isEqualTo",
              "value": "True"
            },
            "name": "allAgents"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\",\"mergeType\":\"inner\",\"leftTable\":\"allAgents\",\"rightTable\":\"versionsTable\",\"leftColumn\":\"name\",\"rightColumn\":\"name\"}],\"projectRename\":[{\"originalName\":\"[allAgents].machineId\",\"mergedName\":\"machineId\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].hostName\",\"mergedName\":\"hostName\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].subscriptionId\",\"mergedName\":\"subscriptionId\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].osType\",\"mergedName\":\"osType\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].machineStatus\",\"mergedName\":\"machineStatus\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].agent\",\"mergedName\":\"agent\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].id\",\"mergedName\":\"id\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].provisioningState\",\"mergedName\":\"provisioningState\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].version\",\"mergedName\":\"version\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[versionsTable].Latest Version\",\"mergedName\":\"Latest Version\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].workspaceResourceId\",\"mergedName\":\"workspaceResourceId\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].autoUpgradeEnabled\",\"mergedName\":\"autoUpgradeEnabled\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].vNextEnabled\",\"mergedName\":\"vNextEnabled\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].statusLevel\",\"mergedName\":\"statusLevel\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].statusCode\",\"mergedName\":\"statusCode\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].statusMessage\",\"mergedName\":\"statusMessage\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].location\",\"mergedName\":\"location\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].tenantId\",\"mergedName\":\"tenantId\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].name\",\"mergedName\":\"name\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].tags\",\"mergedName\":\"tags\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[versionsTable].name\",\"mergedName\":\"Extension Name\",\"fromId\":\"a5bd26b2-3d51-4aef-9654-08e7126d408c\"},{\"originalName\":\"[allAgents].viewType\",\"mergedName\":\"viewType\",\"fromId\":\"unknown\"},{\"originalName\":\"[allAgents].view\",\"mergedName\":\"view\",\"fromId\":\"unknown\"},{\"originalName\":\"[allAgents].viewMatch\",\"mergedName\":\"viewMatch\",\"fromId\":\"unknown\"},{\"originalName\":\"[allAgents].match\",\"mergedName\":\"match\",\"fromId\":\"unknown\"},{\"originalName\":\"[allAgents].type\"},{\"originalName\":\"[versionsTable].Release Notes\"},{\"originalName\":\"[versionsTable].Operating System\"},{\"originalName\":\"[versionsTable].Agent\"}]}",
              "size": 2,
              "showAnalytics": true,
              "title": "{$rowCount} Machines with {agentView}   (Filtered Applied: {agentvername} - {agentver})",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 7,
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "machineId",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true,
                      "customColumnWidthSetting": "26ch"
                    }
                  },
                  {
                    "columnMatch": "hostName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "osType",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "22ch"
                    }
                  },
                  {
                    "columnMatch": "machineStatus",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "18ch"
                    }
                  },
                  {
                    "columnMatch": "agent",
                    "formatter": 13,
                    "formatOptions": {
                      "linkColumn": "id",
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": false,
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "id",
                    "formatter": 5,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true
                    }
                  },
                  {
                    "columnMatch": "provisioningState",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "15ch"
                    }
                  },
                  {
                    "columnMatch": "version",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "!=",
                          "thresholdValue": "[\"Latest Version\"]",
                          "representation": "Important",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "success",
                          "text": "{0}{1}"
                        }
                      ],
                      "customColumnWidthSetting": "18ch"
                    }
                  },
                  {
                    "columnMatch": "Latest Version",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "18ch"
                    }
                  },
                  {
                    "columnMatch": "autoUpgradeEnabled",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "18ch"
                    }
                  },
                  {
                    "columnMatch": "statusLevel",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "18ch"
                    }
                  },
                  {
                    "columnMatch": "statusCode",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "18ch"
                    }
                  },
                  {
                    "columnMatch": "workspaceResourceId",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "subscriptionId",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Extension Name",
                    "formatter": 5
                  }
                ],
                "rowLimit": 10000,
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "machineId",
                    "label": "Machine "
                  },
                  {
                    "columnId": "hostName",
                    "label": "Host Name"
                  },
                  {
                    "columnId": "subscriptionId",
                    "label": "Subscription"
                  },
                  {
                    "columnId": "resourceGroup",
                    "label": "Resource Group"
                  },
                  {
                    "columnId": "osType",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "machineStatus",
                    "label": "Machine Status"
                  },
                  {
                    "columnId": "agent",
                    "label": "Agent"
                  },
                  {
                    "columnId": "provisioningState",
                    "label": "Install State"
                  },
                  {
                    "columnId": "version",
                    "label": "Version"
                  },
                  {
                    "columnId": "workspaceResourceId",
                    "label": "MMA Workspace"
                  },
                  {
                    "columnId": "autoUpgradeEnabled",
                    "label": "Auto Upgrade"
                  },
                  {
                    "columnId": "vNextEnabled",
                    "label": "Windows Unified Agent"
                  },
                  {
                    "columnId": "statusLevel",
                    "label": "Status Level"
                  },
                  {
                    "columnId": "statusCode",
                    "label": "Status Code"
                  },
                  {
                    "columnId": "statusMessage",
                    "label": "Status Message"
                  },
                  {
                    "columnId": "location",
                    "label": "Location"
                  },
                  {
                    "columnId": "tenantId",
                    "label": "Tenant"
                  },
                  {
                    "columnId": "tags",
                    "label": "Tags"
                  }
                ]
              }
            },
            "showPin": false,
            "name": "allAgentsMerge"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "nav",
              "links": [
                {
                  "id": "5a49a8bd-e384-4c1c-8162-afe9495cc95b",
                  "cellValue": "agentTabs",
                  "linkTarget": "step",
                  "linkLabel": "View Machines with {agentView}",
                  "preText": "",
                  "style": "primary"
                }
              ]
            },
            "name": "agentLink"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\",\"mergeType\":\"rightanti\",\"leftTable\":\"allAgents\",\"rightTable\":\"allMachines\",\"leftColumn\":\"machineId\",\"rightColumn\":\"machineId\"}],\"projectRename\":[{\"originalName\":\"[allMachines].machineId\",\"mergedName\":\"machineId\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].hostName\",\"mergedName\":\"hostName\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].subscriptionId\",\"mergedName\":\"subscriptionId\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].resourceGroup\",\"mergedName\":\"resourceGroup\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].osType\",\"mergedName\":\"osType\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].machineStatus\",\"mergedName\":\"machineStatus\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].location\",\"mergedName\":\"location\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].tags\",\"mergedName\":\"tags\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].tenantId\",\"mergedName\":\"tenantId\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].properties\",\"mergedName\":\"properties\",\"fromId\":\"fd2eeed2-489b-4f83-94ab-ce77d7610084\"},{\"originalName\":\"[allMachines].tagFilter\",\"mergedName\":\"tagFilter\",\"fromId\":\"unknown\"},{\"originalName\":\"[allMachines].name\"},{\"originalName\":\"[allMachines].type\"}]}",
              "size": 0,
              "title": "{$rowCount} Machines Missing {agentView}",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 7,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "machineId",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "subscriptionId",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "resourceGroup",
                    "formatter": 1
                  }
                ],
                "rowLimit": 1000,
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "machineId",
                    "label": "Machine"
                  },
                  {
                    "columnId": "hostName",
                    "label": "Host Name"
                  },
                  {
                    "columnId": "subscriptionId",
                    "label": "Subscription"
                  },
                  {
                    "columnId": "resourceGroup",
                    "label": "Resource Group"
                  },
                  {
                    "columnId": "osType",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "machineStatus",
                    "label": "Machine Status"
                  },
                  {
                    "columnId": "location",
                    "label": "Location"
                  },
                  {
                    "columnId": "tags",
                    "label": "Tags"
                  },
                  {
                    "columnId": "tenantId",
                    "label": "Tenant"
                  }
                ]
              }
            },
            "showPin": false,
            "name": "missingMachines"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "connectedMachines"
      },
      "name": "connectedMachines"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type =~ 'Microsoft.Compute/virtualMachines' or \r\ntype == \"microsoft.compute/virtualmachinescalesets\" or\r\ntype == \"microsoft.hybridcompute/machines\"\r\n| extend OS = iif(\r\n                    type =~ 'Microsoft.Compute/virtualMachines', properties.storageProfile.osDisk.osType,\r\n                    iff(type =~ \"microsoft.compute/virtualmachinescalesets\", properties.virtualMachineProfile.storageProfile.osDisk.osType,\r\n                    iff(type =~ \"microsoft.hybridcompute/machines\", properties.osName,\r\n                    'Uknown')))\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| summarize count() by tolower(OS)",
              "size": 4,
              "showAnalytics": true,
              "title": "Operating Systems",
              "showRefreshButton": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "orangeBlue"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false,
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "rightContent": {
                  "columnMatch": "Column1",
                  "formatter": 1
                },
                "showBorder": false,
                "size": "auto"
              }
            },
            "customWidth": "30",
            "name": "operatingSystems"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type =~ 'Microsoft.Compute/virtualMachines' or \r\ntype == \"microsoft.compute/virtualmachinescalesets\" or\r\ntype == \"microsoft.hybridcompute/machines\"\r\n| extend text = iff(\r\n                        type =~ 'Microsoft.Compute/virtualMachines', 'Azure Virtual Machines', \r\n                        iff(type =~ \"microsoft.compute/virtualmachinescalesets\", 'Azure Virtual Machine Scale Sets',\r\n                        iff(type == \"microsoft.hybridcompute/machines\", 'Azure Arc Machines',\r\n                    'Unknown')))\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| summarize Mcount = count() by text",
              "size": 1,
              "showAnalytics": true,
              "title": "Machine Types",
              "showRefreshButton": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Mcount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false
                    }
                  }
                },
                "rightContent": {
                  "columnMatch": "text"
                },
                "showBorder": false,
                "sortCriteriaField": "Mcount",
                "sortOrderField": 2,
                "size": "auto"
              }
            },
            "customWidth": "35",
            "name": "machineTypeQuery"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type =~ 'Microsoft.Compute/virtualMachines' or \r\ntype == \"microsoft.compute/virtualmachinescalesets\" or\r\ntype == \"microsoft.hybridcompute/machines\"\r\n| extend text = iff(\r\n                        type =~ 'Microsoft.Compute/virtualMachines', 'Azure', \r\n                        iff(type =~ \"microsoft.compute/virtualmachinescalesets\", 'Azure',\r\n                        iff(type == \"microsoft.hybridcompute/machines\", properties.detectedProperties.cloudprovider,\r\n                    'Unknown')))\r\n| where text != ''\r\n| extend tagFilter = tostring(case(isempty(\"\"),\"\", strcat('\"',\"\",'\"',\":\",'\"',\"value::1\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| summarize Mcount = count() by text",
              "size": 1,
              "showAnalytics": true,
              "title": "Machine Cloud Providers",
              "showRefreshButton": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Mcount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "rightContent": {
                  "columnMatch": "text"
                },
                "showBorder": false,
                "sortCriteriaField": "Mcount",
                "sortOrderField": 2,
                "size": "auto"
              }
            },
            "customWidth": "35",
            "name": "cloudProvider"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.operationsmanagement/solutions\"\r\n| extend workspaceId = tolower(properties.workspaceResourceId)\r\n| extend sname = split(name, '(')[0]\r\n| extend text = iff(\r\n                        sname =~ 'Security', 'Defender for Cloud', \r\n                        iff(sname =~ 'SecurityCenterFree', 'Defender for Cloud',\r\n                        iff(sname == \"SecurityInsights\", 'Microsoft Sentinel',\r\n                    'null')))\r\n| distinct workspaceId, text\r\n| where text != 'null'\r\n| summarize wscount = count() by text",
              "size": 4,
              "showAnalytics": true,
              "title": "Workspaces with Security Solutions",
              "showRefreshButton": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "wscount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "hotCold"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "rightContent": {
                  "columnMatch": "text"
                },
                "showBorder": false,
                "sortCriteriaField": "text",
                "sortOrderField": 1,
                "size": "auto"
              }
            },
            "customWidth": "40",
            "name": "numberOfWorkspaces"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\" or \r\ntype contains \"microsoft.hybridcompute/machines/extensions\" or\r\ntype contains \"microsoft.compute/virtualmachinescalesets/extensions\"\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| where name =~ 'OmsAgentForLinux' or name =~ 'MicrosoftMonitoringAgent'\r\n| where isnotempty(properties.settings.workspaceId)\r\n| distinct tostring(properties.settings.workspaceId)\r\n| extend text = 'Workspaces'\r\n| summarize wkcount = count() by text",
              "size": 4,
              "title": "Legacy Log Analytic Agent Workspaces",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "wkcount",
                  "formatter": 12,
                  "formatOptions": {
                    "min": 0,
                    "palette": "blueDark"
                  }
                },
                "rightContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "showBorder": false
              }
            },
            "customWidth": "25",
            "name": "legacyMMAWorkspaces"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\" or \r\ntype contains \"microsoft.hybridcompute/machines/extensions\" or\r\ntype contains \"microsoft.compute/virtualmachinescalesets/extensions\"\r\n| where name =~ 'OmsAgentForLinux' or name =~ 'MicrosoftMonitoringAgent'\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| extend workspaceId = tostring(properties.settings.workspaceId)\r\n| extend text = iff(isempty(workspaceId), 'Not Reporting to a Workspace', 'Reporting to a Workspace')\r\n| summarize machineCount = count() by text",
              "size": 4,
              "showAnalytics": true,
              "title": "Legacy Log Analytics Agents",
              "showRefreshButton": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "machineCount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "rightContent": {
                  "columnMatch": "text",
                  "formatter": 1
                },
                "showBorder": false,
                "size": "auto"
              }
            },
            "customWidth": "35",
            "name": "legacyMMA"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\" or \r\ntype contains \"microsoft.hybridcompute/machines/extensions\" or\r\ntype contains \"microsoft.compute/virtualmachinescalesets/extensions\"\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| extend agent = iff(name =~ 'OmsAgentForLinux', 'Legacy Log Analytics', \r\n                        iff(name =~ \"MicrosoftMonitoringAgent\", 'Legacy Log Analytics',\r\n                        iff(name =~ \"AzureSecurityLinuxAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureSecurityWindowsAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureMonitorWindowsAgent\", 'Azure Monitor Agent',\r\n                        iff(name =~ \"AzureMonitorLinuxAgent\", 'Azure Monitor Agent',\r\n                        iff(name has \"MDE.\", 'Defender for Endpoint',\r\n                        iff(name startswith \"AzurePolicyfor\", 'Azure Guest Configuration',\r\n                        iff(name =~ \"LinuxAgent.AzureSecurityCenter\", 'Qualys',\r\n                        iff(name =~ \"WindowsAgent.AzureSecurityCenter\", 'Qualys',\r\n                    name))))))))))\r\n| where agent in ({securityAgents})\r\n| summarize Mcount = count() by agent",
              "size": 4,
              "showAnalytics": true,
              "title": "Agent Types",
              "showRefreshButton": true,
              "exportFieldName": "agent",
              "exportParameterName": "agentTypeagent",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "agent",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "Mcount",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": false,
                "sortCriteriaField": "Mcount",
                "sortOrderField": 2,
                "size": "auto"
              },
              "graphSettings": {
                "type": 0,
                "topContent": {
                  "columnMatch": "agent",
                  "formatter": 1
                },
                "centerContent": {
                  "columnMatch": "Mcount",
                  "formatter": 1,
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "name": "agentTypes"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type contains \"microsoft.compute/virtualmachines/extensions\" or \r\ntype contains \"microsoft.hybridcompute/machines/extensions\" or\r\ntype contains \"microsoft.compute/virtualmachinescalesets/extensions\"\r\n| extend agent = iff(name =~ 'OmsAgentForLinux', 'Legacy Log Analytics', \r\n                        iff(name =~ \"MicrosoftMonitoringAgent\", 'Legacy Log Analytics',\r\n                        iff(name =~ \"AzureSecurityLinuxAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureSecurityWindowsAgent\", 'Defender for Servers P2',\r\n                        iff(name =~ \"AzureMonitorWindowsAgent\", 'Azure Monitor Agent',\r\n                        iff(name =~ \"AzureMonitorLinuxAgent\", 'Azure Monitor Agent',\r\n                        iff(name has \"MDE.\", 'Defender for Endpoint',\r\n                        iff(name startswith \"AzurePolicyfor\", 'Azure Guest Configuration',\r\n                        iff(name =~ \"LinuxAgent.AzureSecurityCenter\", 'Qualys',\r\n                        iff(name =~ \"WindowsAgent.AzureSecurityCenter\", 'Qualys',\r\n                    name))))))))))\r\n| where agent in ({securityAgents})\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| summarize agentCount = count(),\r\nuniqueVersions = dcount(tostring(properties.typeHandlerVersion)),\r\nautoUpgradeEnabled = countif(properties.enableAutomaticUpgrade == true), \r\nautoUpgradeDisabled = countif(properties.enableAutomaticUpgrade == false or isnotempty(properties.enableAutomaticUpgrade)),\r\ninstallSucceeded = countif(properties.provisioningState == 'Succeeded'),\r\ninstallFailed = countif(properties.provisioningState == 'Failed')\r\nby agent\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Agent Breakdown",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "agent",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "agentCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "12ch"
                    }
                  },
                  {
                    "columnMatch": "uniqueVersions",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "purple",
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "autoUpgradeEnabled",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "autoUpgradeDisabled",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "orange",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "installSucceeded",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "green",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "installFailed",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "redBright",
                      "customColumnWidthSetting": "20ch"
                    }
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "agent",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "agent",
                    "label": "Agent"
                  },
                  {
                    "columnId": "agentCount",
                    "label": "Count"
                  },
                  {
                    "columnId": "uniqueVersions",
                    "label": "Unique Versions Deployed"
                  },
                  {
                    "columnId": "autoUpgradeEnabled",
                    "label": "Auto Upgrade Enabled"
                  },
                  {
                    "columnId": "autoUpgradeDisabled",
                    "label": "Auto Upgrade Disabled"
                  },
                  {
                    "columnId": "installSucceeded",
                    "label": "Installation Succeeded"
                  },
                  {
                    "columnId": "installFailed",
                    "label": "Installation Failed"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "agent",
                  "sortOrder": 1
                }
              ],
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "acount",
                  "formatter": 1
                },
                "subtitleContent": {
                  "columnMatch": "agent",
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                "leftContent": {
                  "columnMatch": "agent",
                  "formatter": 10,
                  "formatOptions": {
                    "palette": "blue",
                    "compositeBarSettings": {
                      "labelText": "",
                      "columnSettings": [
                        {
                          "columnName": "acount",
                          "color": "blue"
                        },
                        {
                          "columnName": "autoUpgrade",
                          "color": "blue"
                        }
                      ]
                    }
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "maximumFractionDigits": 2,
                      "maximumSignificantDigits": 3
                    }
                  }
                },
                "showBorder": false,
                "size": "auto"
              }
            },
            "name": "query - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.compute/virtualmachines\" or type == \"microsoft.hybridcompute/machines\"\r\n| parse id with * \"achines/\" ComputerName\r\n| extend ComputerName = tolower(ComputerName)\r\n| join kind=leftouter (\r\nresources\r\n| where (type contains \"microsoft.hybridcompute/machines/extensions\" or type contains \"microsoft.compute/virtualmachines/extensions\") and (name == \"MicrosoftMonitoringAgent\" or name == \"OmsAgentForLinux\" or name == \"OMSAgentForLinux\")\r\n| parse id with * \"achines/\" ComputerName \"/\" *\r\n| extend ComputerName = tolower(ComputerName)\r\n| extend MMA = tostring(name)\r\n) on ComputerName\r\n| join kind=leftouter (\r\nresources\r\n| where (type contains \"microsoft.hybridcompute/machines/extensions\" or type contains \"microsoft.compute/virtualmachines/extensions\") and (name == \"AzureMonitorWindowsAgent\" or name == \"AzureMonitorLinuxAgent\")\r\n| parse id with * \"achines/\" ComputerName \"/\" *\r\n| extend ComputerName = tolower(ComputerName)\r\n| extend AMAgent = tostring(name)\r\n) on ComputerName\r\n| project id, name, ['type'], MMA, AMAgent, subscriptionId, tags\r\n| union (\r\n    resources\r\n    | where type == \"microsoft.compute/virtualmachinescalesets\"\r\n    | project id, name, subscriptionId\r\n    | join kind=leftouter (\r\n    resources\r\n    | where type == \"microsoft.compute/virtualmachinescalesets\"\r\n    | extend extensionprofile = properties.virtualMachineProfile.extensionProfile\r\n    | extend extensions = extensionprofile.extensions\r\n    | mv-expand extensions\r\n    | extend extensiontype = extensions.properties.type\r\n    | where extensiontype in (\"MicrosoftMonitoringAgent\" )\r\n    | project id, name, MMA = extensiontype, subscriptionId\r\n    ) on name \r\n    | join kind=fullouter (\r\n    resources\r\n    | where type == \"microsoft.compute/virtualmachinescalesets\"\r\n    | extend extensionprofile = properties.virtualMachineProfile.extensionProfile\r\n    | extend extensions = extensionprofile.extensions\r\n    | mv-expand extensions\r\n    | extend extensiontype = extensions.properties.type\r\n    | where extensiontype in (\"AzureMonitorWindowsAgent\")\r\n    | project id, name, AMAgent = extensiontype, subscriptionId\r\n    ) on $left.name == $right.name\r\n    | extend ComputerName = iff(isempty(name), name1, name)\r\n    | extend id = iff(isempty(id), id1, id)\r\n    | extend subscriptionId = iff(isempty(subscriptionId), subscriptionId1, subscriptionId)\r\n    | project id, name = ComputerName, [\"type\"] = \"Virtual Machine Scale Sets\", MMA, AMAgent, subscriptionId\r\n)\r\n| extend VMType = case(type == \"microsoft.compute/virtualmachines\", \"Azure Virtual Machines\",\r\n                type == \"microsoft.hybridcompute/machines\", \"Arc-enabled Servers\", \r\n                type == \"Virtual Machine Scale Sets\", \"Virtual Machine Scale Sets\", \r\n                \"Other\")\r\n| extend MMA = iff(isnotempty(MMA_string), MMA_string, MMA_dynamic)\r\n| extend AMAgent = iff(isnotempty(AMAgent_string), AMAgent_string, AMAgent_dynamic)\r\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\r\n| where tostring(tags) contains tagFilter\r\n| summarize MachineCount = count(), BothAgents = countif(isnotempty(MMA) and isnotempty(AMAgent)), MMAOnly = countif(isnotempty(MMA) and isempty(AMAgent)), AMAOnly = countif(isempty(MMA) and isnotempty(AMAgent)) by VMType\r\n| extend counts = pack_array(BothAgents, MMAOnly, AMAOnly)\r\n| extend migstatus = case(BothAgents != 0, \"In Progress\",\r\n                            AMAOnly != 0 and BothAgents == 0 and MMAOnly == 0, \"Completed\", \r\n                            AMAOnly != 0 and MMAOnly != 0, \"In Progress\",\r\n                            MMAOnly != 0 and BothAgents == 0, \"Not Started\", \"Not Started\")",
              "size": 1,
              "showAnalytics": true,
              "title": "Logging Agent Summary and Migration Status",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "subscriptionId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "VMType",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "MachineCount",
                    "formatter": 1,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "BothAgents",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "blue",
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "MMAOnly",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "redBright",
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "AMAOnly",
                    "formatter": 4,
                    "formatOptions": {
                      "min": 0,
                      "palette": "green",
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "counts",
                    "formatter": 22,
                    "formatOptions": {
                      "compositeBarSettings": {
                        "labelText": "[\"migstatus\"]",
                        "columnSettings": [
                          {
                            "columnName": "BothAgents",
                            "color": "blue"
                          },
                          {
                            "columnName": "MMAOnly",
                            "color": "redBright"
                          },
                          {
                            "columnName": "AMAOnly",
                            "color": "green"
                          }
                        ]
                      },
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "migstatus",
                    "formatter": 5
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "VMType",
                    "sortOrder": 1
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "VMType",
                    "label": "Resource Type"
                  },
                  {
                    "columnId": "MachineCount",
                    "label": "Resource Count"
                  },
                  {
                    "columnId": "BothAgents",
                    "label": "Both Agents"
                  },
                  {
                    "columnId": "MMAOnly",
                    "label": "Legacy Log Analytics"
                  },
                  {
                    "columnId": "AMAOnly",
                    "label": "AMA Only"
                  },
                  {
                    "columnId": "counts",
                    "label": "Migration Status"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "VMType",
                  "sortOrder": 1
                }
              ]
            },
            "name": "agentmigrationtracker"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "name": "overview"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.insights/datacollectionrules\"\r\n| extend RuleType = iff(isempty(kind),'Unknown', kind)\r\n| summarize count () by RuleType",
              "size": 4,
              "title": "Rule Types",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "RuleType",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "auto"
              }
            },
            "name": "dcrTypes"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "tabs",
              "links": [
                {
                  "id": "28713e9b-1a5f-41a5-80cc-e045fb8d5caa",
                  "cellValue": "dcrTab",
                  "linkTarget": "parameter",
                  "linkLabel": "By Rule",
                  "subTarget": "byRule",
                  "style": "link",
                  "linkIsContextBlade": true
                },
                {
                  "id": "40802a92-1dc3-4e16-a219-c2355faeb971",
                  "cellValue": "dcrTab",
                  "linkTarget": "parameter",
                  "linkLabel": "By Machine",
                  "subTarget": "byMachine",
                  "style": "link"
                }
              ]
            },
            "name": "links - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\r\n| where type == \"microsoft.insights/datacollectionrules\"\r\n| extend destinations = properties.destinations\r\n| extend dataSources = properties.dataSources\r\n| extend dataFlows = properties.dataFlows\r\n| project id, name, type, kind, location, resourceGroup, subscriptionId, destinations, dataSources, dataFlows, properties",
              "size": 0,
              "showAnalytics": true,
              "title": "Data Collection Rules",
              "showRefreshButton": true,
              "exportedParameters": [
                {
                  "fieldName": "subscriptionId",
                  "parameterName": "dcrSubscriptionId",
                  "parameterType": 1
                },
                {
                  "fieldName": "resourceGroup",
                  "parameterName": "dcrResourceGroup",
                  "parameterType": 1
                },
                {
                  "fieldName": "name",
                  "parameterName": "dataCollectionRuleName",
                  "parameterType": 1
                }
              ],
              "showExportToExcel": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "type",
                    "formatter": 5
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "resourceGroup",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "resourceGroup",
                  "sortOrder": 1
                }
              ]
            },
            "conditionalVisibility": {
              "parameterName": "dcrTab",
              "comparison": "isEqualTo",
              "value": "byRule"
            },
            "name": "dataCollectionRules"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"/subscriptions/{dcrSubscriptionId}/resourceGroups/{dcrResourceGroup}/providers/Microsoft.Insights/dataCollectionRules/{dataCollectionRuleName}/associations?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2021-09-01-preview\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"id\",\"columnid\":\"Machine\",\"columnType\":\"string\",\"substringRegexMatch\":\"(\\\\/subscriptions.*)(\\\\/providers.*|Providers.*)\",\"substringReplace\":\"$1\"},{\"path\":\"properties.dataCollectionRuleId\",\"columnid\":\"dataCollectionRuleId\",\"columnType\":\"string\"}]}}]}",
              "size": 4,
              "title": "Data Collection Rule Associations",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 12
            },
            "conditionalVisibility": {
              "parameterName": "dcrTab",
              "comparison": "isEqualTo",
              "value": "byRule"
            },
            "name": "ruleAssociations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources\n| where type contains \"microsoft.compute/virtualmachines/extensions\" or \n        type contains \"microsoft.hybridcompute/machines/extensions\" or\n        type contains \"microsoft.compute/virtualmachinescalesets/extensions\"\n| project-away kind, managedBy, sku, plan, identity, zones, extendedLocation, systemData, apiVersion\n| extend agent = tostring(iff(name =~ 'OmsAgentForLinux', 'Legacy Log Analytics', \n                        iff(name =~ \"MicrosoftMonitoringAgent\", 'Legacy Log Analytics',\n                        iff(name =~ \"AzureSecurityLinuxAgent\", 'Defender for Servers P2',\n                        iff(name =~ \"AzureSecurityWindowsAgent\", 'Defender for Servers P2',\n                        iff(name =~ \"AzureMonitorWindowsAgent\", 'Azure Monitor Agent',\n                        iff(name =~ \"AzureMonitorLinuxAgent\", 'Azure Monitor Agent',\n                        iff(name has \"MDE.\", 'Defender for Endpoint',\n                        iff(name startswith \"AzurePolicyfor\", 'Azure Guest Configuration',\n                        iff(name =~ \"LinuxAgent.AzureSecurityCenter\", 'Qualys',\n                        iff(name =~ \"WindowsAgent.AzureSecurityCenter\", 'Qualys',\n                    name)))))))))))\n| where agent == 'Azure Monitor Agent' or agent == 'Defender for Servers P2'\n| extend autoUpgradeEnabled = properties.enableAutomaticUpgrade\n| extend provisioningState = tostring(properties.provisioningState)\n| extend version = tostring(properties.typeHandlerVersion)\n| extend statusLevel = tostring(properties.instanceView.status.level)\n| extend statusMessage = tostring(properties.instanceView.status.message)\n| extend statusCode = tostring(properties.instanceView.status.code)\n| parse id with * \"/\" machineId \"/extensions/\" *\n| extend machineId =  strcat('/', tolower(machineId))\n| extend machineName = split(machineId, '/')[-1]\n| join kind=leftouter ( // Join Machines\n        Resources\n        | where type =~ 'Microsoft.Compute/virtualMachines' or \n                type == \"microsoft.compute/virtualmachinescalesets\" or\n                type == \"microsoft.hybridcompute/machines\"\n        | extend machineId = tolower(id)\n        | extend machineStatus = tostring(iff(\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.extended.instanceView.powerState.displayStatus,\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", 'n/a',\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.status,\n                                'uknown'))))\n        | extend osType = tolower(tostring(iff(\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.storageProfile.osDisk.osType,\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", properties.virtualMachineProfile.storageProfile.osDisk.osType,\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.osType,\n                                'uknown')))))\n        | extend hostName = tostring(iff(\n                                type =~ 'Microsoft.Compute/virtualMachines', properties.extended.instanceView.computerName,\n                                iff(type == \"microsoft.compute/virtualmachinescalesets\", properties.virtualMachineProfile.osProfile.computerNamePrefix,\n                                iff(type == \"microsoft.hybridcompute/machines\", properties.machineFqdn,\n                                'uknown'))))\n        | project-away kind, managedBy, apiVersion, sku, plan, identity, zones, extendedLocation, systemData\n        ) on machineId\n| extend tagFilter = tostring(case(isempty(\"{machineTag}\"),\"\", strcat('\"',\"{machineTag}\",'\"',\":\",'\"',\"{machineTagValue}\",'\"')))\n| where tostring(tags) contains tagFilter\n| project-away id1, name1, type1, tenantId1, location1, resourceGroup1, subscriptionId1, properties1, tags1, machineId1, properties\n| project machineId, hostName, machineName, subscriptionId, resourceGroup, location, osType, machineStatus, agent, provisioningState, version, autoUpgradeEnabled, statusLevel, statusCode, statusMessage, tenantId, type, name, id, tags",
              "size": 0,
              "showAnalytics": true,
              "showRefreshButton": true,
              "exportedParameters": [
                {
                  "fieldName": "machineId",
                  "parameterName": "dcrMachineId",
                  "parameterType": 1
                },
                {
                  "fieldName": "machineName",
                  "parameterName": "dcrMachineName",
                  "parameterType": 1
                }
              ],
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "machineId",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "hostName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "machineName",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "subscriptionId",
                    "formatter": 15,
                    "formatOptions": {
                      "linkTarget": null,
                      "showIcon": true,
                      "customColumnWidthSetting": "25ch"
                    }
                  },
                  {
                    "columnMatch": "resourceGroup",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "22ch"
                    }
                  },
                  {
                    "columnMatch": "tenantId",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "type",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "name",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "id",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "kind",
                    "formatter": 5
                  }
                ],
                "filter": true,
                "labelSettings": [
                  {
                    "columnId": "machineId",
                    "label": "Machine"
                  },
                  {
                    "columnId": "hostName",
                    "label": "Host Name"
                  },
                  {
                    "columnId": "subscriptionId",
                    "label": "Subscription"
                  },
                  {
                    "columnId": "resourceGroup",
                    "label": "Resource Group"
                  },
                  {
                    "columnId": "location",
                    "label": "Location"
                  },
                  {
                    "columnId": "osType",
                    "label": "Operating System"
                  },
                  {
                    "columnId": "machineStatus",
                    "label": "Machine Status"
                  },
                  {
                    "columnId": "agent",
                    "label": "Agent"
                  },
                  {
                    "columnId": "provisioningState",
                    "label": "Install State"
                  },
                  {
                    "columnId": "version",
                    "label": "Version"
                  },
                  {
                    "columnId": "autoUpgradeEnabled",
                    "label": "Auto Upgrade"
                  },
                  {
                    "columnId": "tags",
                    "label": "Tags"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "dcrTab",
              "comparison": "isEqualTo",
              "value": "byMachine"
            },
            "name": "allMachinesforDCR"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{dcrMachineId}/providers/Microsoft.Insights/dataCollectionRuleAssociations?\",\"urlParams\":[{\"key\":\"api-version\",\"value\":\"2021-09-01-preview\"}],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value\",\"columns\":[{\"path\":\"properties.dataCollectionRuleId\",\"columnid\":\"dataCollectionRule\",\"columnType\":\"string\"},{\"path\":\"name\",\"columnid\":\"name\",\"columnType\":\"string\"},{\"path\":\"systemData.createdBy\",\"columnid\":\"createdBy\",\"columnType\":\"string\"},{\"path\":\"systemData.createdAt\",\"columnid\":\"createdAt\",\"columnType\":\"datetime\"},{\"path\":\"systemData.lastModifiedBy\",\"columnid\":\"lastModifiedBy\",\"columnType\":\"string\"},{\"path\":\"systemData.lastModifiedAt\",\"columnid\":\"lastModifiedAt\",\"columnType\":\"datetime\"}]}}]}",
              "size": 0,
              "title": "Data Collection Rules for {dcrMachineName}",
              "showRefreshButton": true,
              "showExportToExcel": true,
              "queryType": 12,
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "dataCollectionRule",
                    "formatter": 13,
                    "formatOptions": {
                      "linkTarget": "Resource",
                      "linkIsContextBlade": true,
                      "showIcon": true
                    }
                  },
                  {
                    "columnMatch": "createdAt",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "22ch"
                    }
                  },
                  {
                    "columnMatch": "lastModifiedAt",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "22ch"
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "dataCollectionRule",
                    "label": "Data Collection Rule"
                  },
                  {
                    "columnId": "name",
                    "label": "Name"
                  },
                  {
                    "columnId": "createdBy",
                    "label": "Created By"
                  },
                  {
                    "columnId": "createdAt",
                    "label": "Created Date"
                  },
                  {
                    "columnId": "lastModifiedBy",
                    "label": "Last Modified By"
                  },
                  {
                    "columnId": "lastModifiedAt",
                    "label": "Last Modified Date"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "dcrTab",
              "comparison": "isEqualTo",
              "value": "byMachine"
            },
            "name": "dcrbyVM"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "dataCollectionRules"
      },
      "name": "dataCollectionRules"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "loadType": "always",
        "items": [],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "Tab",
        "comparison": "isEqualTo",
        "value": "agentVersions"
      },
      "name": "agentVersions"
    }
  ],
  "fallbackResourceIds": [
    "azure monitor"
  ],
  "styleSettings": {
    "paddingStyle": "narrow",
    "spacingStyle": "narrow"
  },
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
